{% extends 'base.html' %}
{% load static %}

{% block title %}Phase 3: Vendor Selection - RFP #{{ rfp.rfp_number }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 p-6">
  <div class="max-w-6xl mx-auto space-y-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
      <div class="space-y-2">
        <h1 class="text-3xl font-bold text-gray-900">Phase 3: Vendor Selection</h1>
        <p class="text-gray-600">
          Select qualified vendors based on capability matching and requirements.
        </p>
      </div>
      <div class="flex-shrink-0">
        <div class="status-badge active">
          Phase 3 of 10
        </div>
      </div>
    </div>

    <!-- Search and Filters -->
    <div class="space-y-4">
      <div class="flex flex-col sm:flex-row gap-4">
        <div class="flex-1">
          <form method="GET" action="{% url 'vendor_selection' rfp.rfp_id %}" id="search-form">
            {{ search_form.search_term }}
            {{ search_form.filter_type }}
          </form>
        </div>
        <div class="flex gap-2">
          <button 
            type="button" 
            class="filter-btn {% if active_filter == 'all' %}btn-primary{% else %}btn-outline{% endif %}" 
            data-filter="all"
          >
            All Vendors
          </button>
          <button 
            type="button" 
            class="filter-btn {% if active_filter == 'high-match' %}btn-primary{% else %}btn-outline{% endif %}" 
            data-filter="high-match"
          >
            High Match (90%+)
          </button>
          <button 
            type="button" 
            class="filter-btn {% if active_filter == 'certified' %}btn-primary{% else %}btn-outline{% endif %}" 
            data-filter="certified"
          >
            Highly Certified
          </button>
        </div>
      </div>
      
      <!-- Bulk Actions -->
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div class="flex flex-wrap items-center gap-3">
          <button 
            type="button" 
            class="btn-outline flex items-center gap-2" 
            id="bulk-select-btn"
          >
            <i class="fas fa-check-circle h-4 w-4"></i>
            <span id="bulk-select-text">Select All</span>
          </button>
          <button 
            type="button" 
            class="btn-outline flex items-center gap-2" 
            id="bulk-upload-btn"
          >
            <i class="fas fa-upload h-4 w-4"></i>
            Bulk Upload CSV
          </button>
          <button 
            type="button" 
            class="btn-outline flex items-center gap-2" 
            id="export-list-btn"
          >
            <i class="fas fa-file-export h-4 w-4"></i>
            Export List
          </button>
        </div>
        <div class="text-sm text-gray-600">
          <span id="selected-count">{{ selected_vendor_ids|length }}</span> of <span id="total-count">{{ vendors|length }}</span> vendors selected
        </div>
      </div>
    </div>

    <!-- Vendor Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-2">
      {% for vendor in vendors %}
      <div class="vendor-card {% if vendor.id in selected_vendor_ids %}ring-2 ring-blue-500{% endif %}" data-vendor-id="{{ vendor.id }}">
        <div class="vendor-card-header">
          <div class="flex items-start justify-between">
            <div class="flex items-start gap-3">
              <input 
                type="checkbox" 
                class="vendor-checkbox mt-1" 
                {% if vendor.id in selected_vendor_ids %}checked{% endif %} 
                data-vendor-id="{{ vendor.id }}"
              >
              <div class="space-y-1">
                <div class="flex items-center gap-2">
                  <i class="fas fa-building text-gray-500 h-4 w-4"></i>
                  <h3 class="font-semibold text-lg">{{ vendor.name }}</h3>
                </div>
                <div class="flex items-center gap-4 text-sm text-gray-600">
                  <div class="flex items-center gap-1">
                    <i class="fas fa-map-marker-alt h-3 w-3"></i>
                    {{ vendor.location }}
                  </div>
                  <div class="flex items-center gap-1">
                    <i class="fas fa-star text-yellow-400 h-3 w-3"></i>
                    {{ vendor.rating }}/5
                  </div>
                </div>
              </div>
            </div>
            <div class="
              status-badge 
              {% if vendor.matchScore >= 90 %}awarded{% elif vendor.matchScore >= 80 %}evaluation{% else %}draft{% endif %}
            ">
              {{ vendor.matchScore }}% match
            </div>
          </div>
        </div>
        <div class="vendor-card-content space-y-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
            <div class="flex items-center gap-2">
              <i class="fas fa-envelope text-gray-500 h-3 w-3"></i>
              <span class="truncate">{{ vendor.email }}</span>
            </div>
            <div class="flex items-center gap-2">
              <i class="fas fa-phone text-gray-500 h-3 w-3"></i>
              <span>{{ vendor.phone }}</span>
            </div>
            <div class="flex items-center gap-2">
              <i class="fas fa-globe text-gray-500 h-3 w-3"></i>
              <span class="truncate">{{ vendor.website }}</span>
            </div>
            <div class="flex items-center gap-2">
              <i class="fas fa-award text-gray-500 h-3 w-3"></i>
              <span>{{ vendor.experience }}</span>
            </div>
          </div>

          <div class="space-y-2">
            <h4 class="font-medium text-sm">Capabilities</h4>
            <div class="flex flex-wrap gap-1">
              {% for capability in vendor.capabilities %}
              <div class="badge-secondary text-xs">
                {{ capability }}
              </div>
              {% endfor %}
            </div>
          </div>

          <div class="space-y-2">
            <h4 class="font-medium text-sm">Certifications</h4>
            <div class="flex flex-wrap gap-1">
              {% for cert in vendor.certifications %}
              <div class="badge-outline text-xs">
                {{ cert }}
              </div>
              {% endfor %}
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4 pt-2 border-t">
            <div>
              <span class="text-xs text-gray-500">Company Size</span>
              <p class="text-sm font-medium">{{ vendor.employees }}</p>
            </div>
            <div>
              <span class="text-xs text-gray-500">Category</span>
              <p class="text-sm font-medium">{{ vendor.category }}</p>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Selection Summary -->
    <div id="selection-summary" class="phase-card bg-blue-50 border-blue-200 {% if not selected_vendor_ids %}hidden{% endif %}">
      <div class="pt-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
          <div>
            <h3 class="font-semibold text-lg">Selection Summary</h3>
            <p class="text-gray-600">
              <span id="summary-count">{{ selected_vendor_ids|length }}</span> vendors selected for invitation
            </p>
            <div class="flex flex-wrap gap-2 mt-2" id="selected-vendors-list">
              {% for vendor in vendors %}
                {% if vendor.id in selected_vendor_ids %}
                <div class="status-badge active selected-vendor-badge" data-vendor-id="{{ vendor.id }}">
                  {{ vendor.name }}
                </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
          <div class="flex gap-2">
            <a href="{% url 'vendor_selection' rfp.rfp_id %}" class="btn-outline">
              Previous
            </a>
            <form method="POST" action="{% url 'generate_vendor_urls' rfp.rfp_id %}">
              {% csrf_token %}
              <button type="submit" class="gradient-primary flex items-center">
                Generate URLs & Send Invitations
                <i class="fas fa-arrow-right h-4 w-4 ml-2"></i>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Manual Vendor Entry -->
<div id="manual-entry-modal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="text-lg font-semibold">Add New Vendor</h2>
      <button type="button" class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <form method="POST" action="{% url 'vendor_manual_entry' rfp.rfp_id %}" id="manual-entry-form">
        {% csrf_token %}
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Company Name*</label>
            {{ manual_entry_form.company_name }}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Legal Name</label>
            {{ manual_entry_form.legal_name }}
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email*</label>
            {{ manual_entry_form.email }}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
            {{ manual_entry_form.phone }}
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Website</label>
            {{ manual_entry_form.website }}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
            {{ manual_entry_form.location }}
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Industry Sector</label>
            {{ manual_entry_form.industry_sector }}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Employee Count</label>
            {{ manual_entry_form.employee_count }}
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Years of Experience</label>
            {{ manual_entry_form.experience_years }}
          </div>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
          {{ manual_entry_form.description }}
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Capabilities</label>
          {{ manual_entry_form.capabilities }}
          <p class="text-xs text-gray-500 mt-1">Enter capabilities separated by commas (e.g., Cloud Expert, DevOps, Security)</p>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Certifications</label>
          {{ manual_entry_form.certifications }}
          <p class="text-xs text-gray-500 mt-1">Enter certifications separated by commas (e.g., ISO 27001, SOC 2)</p>
        </div>
        
        <div class="flex justify-end gap-2 mt-6">
          <button type="button" class="btn-outline modal-close">Cancel</button>
          <button type="submit" class="btn-primary">Add Vendor</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal for Bulk Upload -->
<div id="bulk-upload-modal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="text-lg font-semibold">Bulk Upload Vendors</h2>
      <button type="button" class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <form method="POST" action="{% url 'vendor_bulk_upload' rfp.rfp_id %}" enctype="multipart/form-data" id="bulk-upload-form">
        {% csrf_token %}
        
        <div class="mb-4">
          <p class="mb-2">Upload a CSV file with vendor information. The file should have the following columns:</p>
          <div class="bg-gray-50 p-3 rounded text-sm">
            <code>company_name, legal_name, email, phone, website, location, industry_sector, employee_count, experience_years, description, capabilities, certifications</code>
          </div>
        </div>
        
        <div class="mb-4">
          <div class="flex items-center justify-center w-full">
            <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
              <div class="flex flex-col items-center justify-center pt-5 pb-6">
                <i class="fas fa-cloud-upload-alt text-gray-500 mb-2 text-2xl"></i>
                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                <p class="text-xs text-gray-500">CSV files only</p>
              </div>
              {{ bulk_upload_form.csv_file }}
              <p id="file-name" class="mt-2 text-sm text-gray-500"></p>
            </label>
          </div>
        </div>
        
        <div class="flex justify-between gap-2 mt-6">
          <a href="{% static 'templates/vendor_template.csv' %}" download class="btn-outline flex items-center gap-1">
            <i class="fas fa-download h-4 w-4"></i>
            Download Template
          </a>
          <div>
            <button type="button" class="btn-outline modal-close">Cancel</button>
            <button type="submit" class="btn-primary ml-2">Upload</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.vendor-card {
  @apply bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow p-4;
}

.vendor-card-header {
  @apply pb-4;
}

.vendor-card-content {
  @apply pt-4;
}

.phase-card {
  @apply bg-white border border-gray-200 rounded-lg shadow-sm p-4;
}

.status-badge {
  @apply px-3 py-1 rounded-full text-sm font-medium;
}

.status-badge.active {
  @apply bg-green-100 text-green-800 border border-green-200;
}

.status-badge.awarded {
  @apply bg-green-100 text-green-800 border border-green-200;
}

.status-badge.evaluation {
  @apply bg-yellow-100 text-yellow-800 border border-yellow-200;
}

.status-badge.draft {
  @apply bg-gray-100 text-gray-800 border border-gray-200;
}

.badge-secondary {
  @apply px-2 py-1 rounded-full bg-purple-100 text-purple-800 border border-purple-200;
}

.badge-outline {
  @apply px-2 py-1 rounded-full bg-white text-gray-800 border border-gray-200;
}

.btn-primary {
  @apply px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700;
}

.btn-outline {
  @apply px-4 py-2 bg-white text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-50;
}

.gradient-primary {
  @apply px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800;
}

/* Modal Styles */
.modal {
  @apply fixed inset-0 z-50 overflow-y-auto;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
  @apply bg-white rounded-lg shadow-xl mx-auto mt-20 max-w-2xl;
}

.modal-header {
  @apply flex justify-between items-center p-4 border-b;
}

.modal-body {
  @apply p-4;
}

.modal-close {
  @apply text-gray-500 hover:text-gray-700 text-xl font-bold;
}

.hidden {
  display: none;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Filter buttons
  const filterButtons = document.querySelectorAll('.filter-btn');
  const filterTypeInput = document.querySelector('#id_filter_type');
  const searchForm = document.querySelector('#search-form');
  
  filterButtons.forEach(button => {
    button.addEventListener('click', function() {
      const filter = this.dataset.filter;
      filterTypeInput.value = filter;
      searchForm.submit();
    });
  });
  
  // Vendor selection
  const vendorCheckboxes = document.querySelectorAll('.vendor-checkbox');
  const selectedCountElement = document.querySelector('#selected-count');
  const summaryCountElement = document.querySelector('#summary-count');
  const selectionSummary = document.querySelector('#selection-summary');
  const selectedVendorsList = document.querySelector('#selected-vendors-list');
  
  vendorCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const vendorId = this.dataset.vendorId;
      const vendorCard = document.querySelector(`.vendor-card[data-vendor-id="${vendorId}"]`);
      const isChecked = this.checked;
      
      // Update UI
      if (isChecked) {
        vendorCard.classList.add('ring-2', 'ring-blue-500');
      } else {
        vendorCard.classList.remove('ring-2', 'ring-blue-500');
      }
      
      // Send AJAX request to update selection
      fetch(`/rfp/rfps/{{ rfp.rfp_id }}/vendors/update-selection/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          vendor_id: vendorId,
          is_selected: isChecked
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update selection count
          const selectedCount = document.querySelectorAll('.vendor-checkbox:checked').length;
          selectedCountElement.textContent = selectedCount;
          summaryCountElement.textContent = selectedCount;
          
          // Update selection summary
          if (selectedCount > 0) {
            selectionSummary.classList.remove('hidden');
            
            // Update selected vendors list
            const vendorName = vendorCard.querySelector('h3').textContent;
            
            if (isChecked) {
              // Add vendor to list
              const badge = document.createElement('div');
              badge.className = 'status-badge active selected-vendor-badge';
              badge.dataset.vendorId = vendorId;
              badge.textContent = vendorName;
              selectedVendorsList.appendChild(badge);
            } else {
              // Remove vendor from list
              const badge = document.querySelector(`.selected-vendor-badge[data-vendor-id="${vendorId}"]`);
              if (badge) {
                badge.remove();
              }
            }
          } else {
            selectionSummary.classList.add('hidden');
          }
        }
      });
    });
  });
  
  // Bulk select button
  const bulkSelectBtn = document.querySelector('#bulk-select-btn');
  const bulkSelectText = document.querySelector('#bulk-select-text');
  
  bulkSelectBtn.addEventListener('click', function() {
    const allChecked = document.querySelectorAll('.vendor-checkbox:checked').length === vendorCheckboxes.length;
    const action = allChecked ? false : true;
    
    // Update UI
    vendorCheckboxes.forEach(checkbox => {
      checkbox.checked = action;
      const vendorId = checkbox.dataset.vendorId;
      const vendorCard = document.querySelector(`.vendor-card[data-vendor-id="${vendorId}"]`);
      
      if (action) {
        vendorCard.classList.add('ring-2', 'ring-blue-500');
      } else {
        vendorCard.classList.remove('ring-2', 'ring-blue-500');
      }
    });
    
    // Send AJAX request to update selection
    fetch(`/rfp/rfps/{{ rfp.rfp_id }}/vendors/bulk-select/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        select_all: true
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update selection count
        const selectedCount = action ? vendorCheckboxes.length : 0;
        selectedCountElement.textContent = selectedCount;
        summaryCountElement.textContent = selectedCount;
        
        // Update bulk select button text
        bulkSelectText.textContent = action ? 'Deselect All' : 'Select All';
        
        // Update selection summary
        if (selectedCount > 0) {
          selectionSummary.classList.remove('hidden');
          
          // Update selected vendors list
          selectedVendorsList.innerHTML = '';
          
          if (action) {
            // Add all vendors to list
            document.querySelectorAll('.vendor-card').forEach(card => {
              const vendorId = card.dataset.vendorId;
              const vendorName = card.querySelector('h3').textContent;
              
              const badge = document.createElement('div');
              badge.className = 'status-badge active selected-vendor-badge';
              badge.dataset.vendorId = vendorId;
              badge.textContent = vendorName;
              selectedVendorsList.appendChild(badge);
            });
          }
        } else {
          selectionSummary.classList.add('hidden');
        }
      }
    });
  });
  
  // Modal functionality
  const manualEntryBtn = document.querySelector('#manual-entry-btn');
  const bulkUploadBtn = document.querySelector('#bulk-upload-btn');
  const manualEntryModal = document.querySelector('#manual-entry-modal');
  const bulkUploadModal = document.querySelector('#bulk-upload-modal');
  const modalCloseButtons = document.querySelectorAll('.modal-close');
  
  // Show manual entry modal
  document.querySelector('#manual-entry-btn').addEventListener('click', function() {
    manualEntryModal.classList.remove('hidden');
  });
  
  // Show bulk upload modal
  bulkUploadBtn.addEventListener('click', function() {
    bulkUploadModal.classList.remove('hidden');
  });
  
  // Close modals
  modalCloseButtons.forEach(button => {
    button.addEventListener('click', function() {
      manualEntryModal.classList.add('hidden');
      bulkUploadModal.classList.add('hidden');
    });
  });
  
  // File upload display
  const fileInput = document.querySelector('#id_csv_file');
  const fileNameDisplay = document.querySelector('#file-name');
  
  fileInput.addEventListener('change', function() {
    if (this.files.length > 0) {
      fileNameDisplay.textContent = this.files[0].name;
    } else {
      fileNameDisplay.textContent = '';
    }
  });
});
</script>
{% endblock %}
