# AI Risk Extraction - Enhanced Detection Approach

## Overview
Modified both `risk_ai_doc.py` and `risk_instance_ai.py` to intelligently detect and extract risks from structured documents.

## Key Changes

### 1. **Detection Phase** (NEW)
- **Pattern Matching**: Detects risks by finding "Risk X: Title" patterns in the document
- **Block Extraction**: Extracts the content block for each risk from the pattern to the next risk or end of document
- **Field Extraction**: Uses regex to extract fields that are explicitly present (e.g., Description, Possible Damage, Risk Priority, etc.)

### 2. **Processing Phase** (MODIFIED)
- **No AI-Generated Titles**: Risk titles are ALWAYS extracted from the document, never generated by AI
- **Selective AI Usage**: AI is only called to fill in MISSING fields, not to extract fields already present in the document
- **Metadata Tracking**: Each risk includes metadata showing which fields were extracted vs. AI-generated

### 3. **Fallback Behavior**
- If no "Risk X:" patterns are found, falls back to the old AI-based extraction
- Ensures backwards compatibility with unstructured documents

## How It Works

### Example: risk_register.pdf

**Document Structure:**
```
Risk 1: Non-Compliance with Capital Adequacy Standards
Description: Risk associated with failure to maintain adequate capital reserves.
Possible Damage: Potential financial insolvency and regulatory fines.
Risk Priority: High
Status: 75.5
Risk Type: External
Risk Likelihood: 7
Risk Impact: 9
â€” End of Risk â€”
```

**Processing Flow:**

1. **Detection**: 
   - Found pattern: "Risk 1: Non-Compliance with Capital Adequacy Standards"
   - Extracted title: "Non-Compliance with Capital Adequacy Standards"
   - Extracted block: Everything from "Description:" to "â€” End of Risk â€”"

2. **Field Extraction**:
   - âœ“ RiskTitle: "Non-Compliance with Capital Adequacy Standards" (EXTRACTED)
   - âœ“ RiskDescription: "Risk associated with failure..." (EXTRACTED)
   - âœ“ PossibleDamage: "Potential financial insolvency..." (EXTRACTED)
   - âœ“ RiskPriority: "High" (EXTRACTED)
   - âœ“ RiskExposureRating: 75.5 (EXTRACTED from "Status")
   - âœ“ RiskType: "External" (EXTRACTED)
   - âœ“ RiskLikelihood: 7 (EXTRACTED)
   - âœ“ RiskImpact: 9 (EXTRACTED)

3. **AI Inference** (for missing fields only):
   - ðŸ¤– Category: AI infers from context
   - ðŸ¤– Criticality: AI infers from priority and exposure
   - ðŸ¤– BusinessImpact: AI infers from description and damage
   - ðŸ¤– RiskMitigation: AI generates from context
   - ðŸ¤– CreatedAt: AI uses today's date
   - ðŸ¤– RiskMultiplierX/Y: AI uses defaults

4. **Final Output**:
   ```json
   {
     "RiskTitle": "Non-Compliance with Capital Adequacy Standards",
     "RiskDescription": "Risk associated with failure...",
     "RiskPriority": "High",
     "RiskExposureRating": 75.5,
     ...
     "_meta": {
       "extracted_fields": ["RiskTitle", "RiskDescription", "PossibleDamage", ...],
       "ai_generated_fields": ["Category", "Criticality", "BusinessImpact", ...]
     }
   }
   ```

## Benefits

1. **Accuracy**: Risk titles and present fields are extracted exactly as written, no AI hallucination
2. **Efficiency**: Reduces AI calls by only inferring missing fields
3. **Transparency**: Metadata shows which fields were extracted vs. AI-generated
4. **Cost-Effective**: Fewer tokens sent to OpenAI API
5. **Faster Processing**: Regex extraction is instant, AI only called when needed

## Field Mappings

### risk_ai_doc.py
| Document Field | Database Field |
|----------------|----------------|
| Description | RiskDescription |
| Possible Damage | PossibleDamage |
| Risk Priority | RiskPriority |
| Status | RiskExposureRating |
| Mitigation | RiskMitigation |
| Created At | CreatedAt |
| Risk Type | RiskType |
| Risk Likelihood | RiskLikelihood |
| Risk Impact | RiskImpact |
| Category | Category |
| Criticality | Criticality |
| Business Impact | BusinessImpact |

### risk_instance_ai.py
Additional fields:
- Origin
- Appetite
- Risk Response Type
- Risk Response Description
- Risk Owner
- Risk Status
- Mitigation Status
- Modified Mitigations
- Risk Form Details
- Reviewer

## Usage

No changes required in API calls. The functions work the same way:

```python
# Upload and process
POST /api/risk/upload-and-process-risk-document/
POST /api/risk/upload-and-process-risk-instance-document/

# The new detection happens automatically
# If "Risk X:" patterns found â†’ Uses new detection approach
# If no patterns found â†’ Falls back to old AI extraction
```

## Testing

Test with risk_register.pdf:
- Should detect 6 risks
- Should extract titles as-is from document
- Should extract all present fields using regex
- Should only call AI for missing fields

